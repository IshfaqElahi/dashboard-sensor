<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental & Radiation Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .safe {
            background: #28a745;
            color: white;
        }

        .warning {
            background: #ffc107;
            color: #000;
        }

        .danger {
            background: #dc3545;
            color: white;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1em;
            color: #ccc;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .chart-container {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-container {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 750px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .map-description {
            color: #aaa;
            margin-bottom: 15px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .map-iframe {
            width: 100%;
            height: 650px;
            border: none;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .single-map-iframe {
            width: 100%;
            height: 700px;
            border: none;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .map-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
        }

        .map-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            color: #dedede;
        }

        canvas {
            max-width: 100%;
            height: 300px !important;
        }

        .last-update {
            text-align: center;
            color: #888;
            margin-top: 20px;
        }

        .alert-banner {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
            display: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .loading {
            text-align: center;
            font-size: 1.5em;
            padding: 50px;
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section-divider {
            grid-column: 1 / -1;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            margin: 20px 0;
        }

        .section-title {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 2em;
            margin: 30px 0 20px 0;
            color: #fff;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
        }

        .map-info-box {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #f6f6f6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .map-info-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #ffffff;
        }

        .map-info-box p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #667eea;
        }

        .tab-button.active {
            background: #667eea;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .map-grid {
                grid-template-columns: 1fr;
            }

            .map-iframe {
                height: 500px;
            }

            .single-map-iframe {
                height: 550px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Environmental & Radiation Monitoring System</h1>
        <div class="subtitle">ISOTOPER B15 Real-time Dashboard with Spatial Analysis</div>

        <div id="alertBanner" class="alert-banner"></div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="loading" class="loading">‚è≥ Loading data from sensors...</div>

        <div id="dashboard" style="display: none;">

            <div class="section-title">üìä ISOTOPER B15 Real-Time Sensor Readings</div>

            <div class="grid">
                <div class="card">
                    <h2>üå°Ô∏è Temperature</h2>
                    <div class="metric">
                        <span class="metric-label">Current</span>
                        <span class="metric-value" id="temp">--</span>
                    </div>
                    <div class="status-badge" id="temp-status">--</div>
                </div>

                <div class="card">
                    <h2>üíß Humidity</h2>
                    <div class="metric">
                        <span class="metric-label">Current</span>
                        <span class="metric-value" id="humidity">--</span>
                    </div>
                    <div class="status-badge" id="humidity-status">--</div>
                </div>

                <div class="card">
                    <h2>üí® Hydrogen Gas (MQ8)</h2>
                    <div class="metric">
                        <span class="metric-label">Analog Raw (ADC)</span>
                        <span class="metric-value" id="h2-raw">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Voltage</span>
                        <span class="metric-value" id="h2-voltage">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Air Quality</span>
                        <span class="metric-value" id="h2-do">--</span>
                    </div>
                    <div class="status-badge" id="h2-status">--</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h2>‚ò¢Ô∏è Radiation Level</h2>
                    <div class="metric">
                        <span class="metric-label">Dose Rate</span>
                        <span class="metric-value" id="dose">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPM</span>
                        <span class="metric-value" id="cpm">--</span>
                    </div>
                    <div class="status-badge" id="rad-status">--</div>
                </div>

                <div class="card">
                    <h2>üìä Radiation Stats</h2>
                    <div class="metric">
                        <span class="metric-label">CPS</span>
                        <span class="metric-value" id="cps">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Status</span>
                        <span class="metric-value" id="rad-text">--</span>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>
            <div class="section-title">üìà Historical Trends</div>

            <div class="grid">
                <div class="chart-container">
                    <h2>üìà Radiation Dose Trend (Last 100 Readings)</h2>
                    <canvas id="doseChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>üìà Temperature & Humidity Trend</h2>
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <div class="section-divider"></div>
            <div class="section-title">üó∫Ô∏è Radiation Dispersion - Spatial Analysis</div>

            <div class="grid">
                <div class="map-container">
                    <h2>üó∫Ô∏è Interactive Radiation Maps</h2>

                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchMapTab('both')">
                            üìä Both Maps (Side-by-Side)
                        </button>
                        <button class="tab-button" onclick="switchMapTab('interpolated')">
                            üåê Interpolated Dispersion Map
                        </button>
                        <button class="tab-button" onclick="switchMapTab('measurement')">
                            üìç Measurement Points Map
                        </button>
                    </div>

                    <div id="tab-both" class="tab-content active">
                        <div class="map-info-box">
                            <h3>üìç Viewing Both Maps</h3>
                            <p><strong>Left:</strong> Interpolated radiation field (400+ data points)</p>
                            <p><strong>Right:</strong> Specific measurement points with GPS coordinates</p>
                        </div>

                        <div class="map-grid">
                            <div class="map-card">
                                <h3>üåê Interpolated Dispersion</h3>
                                <iframe class="map-iframe" src="radiation_dispersion_map.html"
                                    title="Interpolated Radiation Map" loading="lazy"></iframe>
                            </div>

                            <div class="map-card">
                                <h3>üìç Measurement Points</h3>
                                <iframe class="map-iframe" src="radiation_map_light.html" title="Measurement Points Map"
                                    loading="lazy"></iframe>
                            </div>
                        </div>
                    </div>

                    <div id="tab-interpolated" class="tab-content">
                        <div class="map-info-box">
                            <h3>üåê Interpolated Radiation Dispersion Map</h3>
                            <p>Linear interpolation from 400+ data points showing radiation distribution patterns.</p>
                            <p><strong>Features:</strong> Heatmap ‚Ä¢ Risk contours ‚Ä¢ Statistical analysis</p>
                        </div>

                        <div class="map-description">
                            <strong>üîç How to Use:</strong><br>
                            ‚Ä¢ <strong>Zoom/Pan:</strong> Mouse wheel + drag<br>
                            ‚Ä¢ <strong>Layers:</strong> Toggle views in top-right control<br>
                            ‚Ä¢ <strong>Contours:</strong> Enable "Contour Lines" to see risk zones<br>
                            ‚Ä¢ <strong>Statistics:</strong> View stats panel on top-right
                        </div>

                        <iframe class="single-map-iframe" src="radiation_dispersion_map.html" title="Interpolated Map"
                            loading="lazy"></iframe>
                    </div>

                    <div id="tab-measurement" class="tab-content">
                        <div class="map-info-box">
                            <h3>üìç Radiation Measurement Points</h3>
                            <p>GPS-tagged measurement locations with detailed risk assessments.</p>
                            <p><strong>Features:</strong> Precise coordinates ‚Ä¢ Risk zones ‚Ä¢ Safety calculations</p>
                        </div>

                        <div class="map-description">
                            <strong>üîç How to Use:</strong><br>
                            ‚Ä¢ <strong>Click Markers:</strong> View detailed radiation data<br>
                            ‚Ä¢ <strong>Risk Zones:</strong> Toggle layer to see affected areas<br>
                            ‚Ä¢ <strong>Map Styles:</strong> Switch between Light, Satellite, Street views
                        </div>

                        <iframe class="single-map-iframe" src="radiation_map_light.html" title="Measurement Map"
                            loading="lazy"></iframe>
                    </div>

                    <div class="map-description" style="margin-top: 15px; font-size: 0.85em; color: #888;">
                        <strong>‚ö†Ô∏è Note:</strong> Ensure both map HTML files are in the same directory as this
                        dashboard.
                    </div>
                </div>
            </div>

        </div>

        <div class="last-update">
            <div>Environmental Sensors: <span id="envUpdate">--</span></div>
            <div>Radiation Sensor: <span id="radUpdate">--</span></div>
        </div>
    </div>
    <script>
        // ===== CONFIGURATION =====
        const GM_TUBE_API = 'https://script.google.com/macros/s/AKfycbzCBRfLEIenGJcOjMiCfhb3aIdF_kop9LOhxdMUeVzn__Sl10te8O-uQcWIacMrw4WpWw/exec';
        const ENV_SENSOR_API = 'https://script.google.com/macros/s/AKfycbyp0PaEELfInYzXKDQxFC5oCGqDaUvf9LptF224IkEq3BBQpCXFol5jRGmjsADJvY50/exec';
        const UPDATE_INTERVAL = 5000;

        const THRESHOLDS = {
            temperature: { min: 18, max: 30 },
            humidity: { min: 30, max: 70 },
            dose: { safe: 0.30, elevated: 1.0, high: 10.0 }
        };

        let doseChart, envChart;
        let envData = null;
        let radData = null;

        // ===== MAP TAB SWITCHING =====
        function switchMapTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ===== DATA FETCHING =====
        async function fetchEnvData() {
            try {
                const response = await fetch(ENV_SENSOR_API);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error('Error fetching environmental data:', error);
                showError('Failed to load environmental sensor data');
                return null;
            }
        }

        async function fetchRadData() {
            try {
                const response = await fetch(GM_TUBE_API);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error('Error fetching radiation data:', error);
                showError('Failed to load radiation sensor data');
                return null;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = '‚ö†Ô∏è ' + message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 10000);
        }

        // ===== UPDATE DASHBOARD =====
        function updateDashboard() {
            if (!envData && !radData) return;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            if (envData && envData.latest) {
                const env = envData.latest;
                document.getElementById('temp').textContent = env.temperature + '¬∞C';
                updateStatus('temp-status', env.temperature, THRESHOLDS.temperature.min, THRESHOLDS.temperature.max);
                document.getElementById('humidity').textContent = env.humidity + '%';
                updateStatus('humidity-status', env.humidity, THRESHOLDS.humidity.min, THRESHOLDS.humidity.max);
                document.getElementById('h2-raw').textContent = env.h2_raw;
                document.getElementById('h2-voltage').textContent = env.h2_voltage + 'V';
                document.getElementById('h2-do').textContent = env.h2_do;

                const h2Status = document.getElementById('h2-status');
                if (env.h2_do == 1) {
                    h2Status.textContent = '‚úÖ Clean Air';
                    h2Status.className = 'status-badge safe';
                } else {
                    h2Status.textContent = 'üö® H‚ÇÇ Detected!';
                    h2Status.className = 'status-badge danger';
                    showAlert('Hydrogen gas detected!');
                }

                document.getElementById('envUpdate').textContent = new Date(env.timestamp).toLocaleString();
                updateEnvChart(envData.history);
            }

            if (radData && radData.latest) {
                const rad = radData.latest;
                document.getElementById('dose').textContent = rad.dose + ' ¬µSv/h';
                document.getElementById('cpm').textContent = rad.cpm;
                document.getElementById('cps').textContent = rad.cps;
                document.getElementById('rad-text').textContent = rad.status;

                const radStatus = document.getElementById('rad-status');
                if (rad.dose < THRESHOLDS.dose.safe) {
                    radStatus.textContent = '‚úÖ Normal';
                    radStatus.className = 'status-badge safe';
                } else if (rad.dose < THRESHOLDS.dose.elevated) {
                    radStatus.textContent = '‚ö†Ô∏è Elevated';
                    radStatus.className = 'status-badge warning';
                } else if (rad.dose < THRESHOLDS.dose.high) {
                    radStatus.textContent = '‚ö†Ô∏è High';
                    radStatus.className = 'status-badge warning';
                    showAlert('High radiation detected!');
                } else {
                    radStatus.textContent = 'üö® DANGER';
                    radStatus.className = 'status-badge danger';
                    showAlert('DANGEROUS radiation levels!');
                }

                document.getElementById('radUpdate').textContent = new Date(rad.timestamp).toLocaleString();
                updateDoseChart(radData.history);
            }
        }

        function updateStatus(elementId, value, min, max) {
            const element = document.getElementById(elementId);
            if (value < min || value > max) {
                element.textContent = '‚ö†Ô∏è Out of Range';
                element.className = 'status-badge warning';
            } else {
                element.textContent = '‚úÖ Normal';
                element.className = 'status-badge safe';
            }
        }

        function showAlert(message) {
            const banner = document.getElementById('alertBanner');
            banner.textContent = '‚ö†Ô∏è ' + message;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 10000);
        }

        // ===== CHARTS =====
        function updateDoseChart(history) {
            if (!history || history.length === 0) return;
            const timestamps = history.map(row => new Date(row.timestamp).toLocaleTimeString());
            const doses = history.map(row => row.dose);

            if (doseChart) doseChart.destroy();
            const doseCtx = document.getElementById('doseChart').getContext('2d');
            doseChart = new Chart(doseCtx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Dose Rate (¬µSv/h)',
                        data: doses,
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function updateEnvChart(history) {
            if (!history || history.length === 0) return;
            const timestamps = history.map(row => new Date(row.timestamp).toLocaleTimeString());
            const temps = history.map(row => row.temperature);
            const humidities = history.map(row => row.humidity);

            if (envChart) envChart.destroy();
            const envCtx = document.getElementById('envChart').getContext('2d');
            envChart = new Chart(envCtx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: temps,
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humidity (%)',
                            data: humidities,
                            borderColor: '#4bc0c0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#aaa' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function fetchAllData() {
            const [env, rad] = await Promise.all([fetchEnvData(), fetchRadData()]);
            if (env) envData = env;
            if (rad) radData = rad;
            updateDashboard();
        }

        async function init() {
            await fetchAllData();
        }

        setInterval(fetchAllData, UPDATE_INTERVAL);
        init();
    </script>
</body>

</html>